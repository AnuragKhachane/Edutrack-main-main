<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoTend - Smart Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Load face-api.js from a CDN and defer execution until the page is fully parsed -->
    <script src="https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div id="welcomeScreen" class="screen active">
        <div class="container vh-100 d-flex align-items-center justify-content-center">
            <div class="text-center">
                <div class="logo-container mb-4">
                    <img src="logo1.png" alt="GeoTend Logo" class="GeoTend-logo mx-auto d-block mb-2">
                    <h1 class="display-4 fw-bold mb-2">GeoTend</h1>
                    <p class="lead">Smart Attendance Management System</p>
                </div>
                <div class="role-selection">
                    <h3 class="mb-4">Select Your Role</h3>
                    <div class="row g-4 justify-content-center">
                        <div class="col-md-4">
                            <div class="card role-card h-100" data-role="student">
                                <div class="card-body text-center p-4">
                                    <div class="role-icon mb-3">
                                        <i class="bi bi-camera-video-fill"></i>
                                        <span class="badge bg-primary position-absolute">Camera</span>
                                    </div>
                                    <h5 class="card-title">Student</h5>
                                    <p class="card-text">Mark attendance using face recognition camera</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card role-card h-100" data-role="teacher">
                                <div class="card-body text-center p-4">
                                    <div class="role-icon mb-3">
                                        <i class="bi bi-person-check-fill"></i>
                                        <span class="badge bg-success position-absolute">Manual</span>
                                    </div>
                                    <h5 class="card-title">Teacher</h5>
                                    <p class="card-text">Manage class attendance and view reports</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card role-card h-100" data-role="administrator">
                                <div class="card-body text-center p-4">
                                    <div class="role-icon mb-3">
                                        <i class="bi bi-gear-fill"></i>
                                        <span class="badge bg-warning position-absolute">Admin</span>
                                    </div>
                                    <h5 class="card-title">Administrator</h5>
                                    <p class="card-text">System analytics and user management</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="screen">
        <div class="container vh-100 d-flex align-items-center justify-content-center">
            <div class="row w-100">
                <div class="col-md-6 offset-md-3 col-lg-4 offset-lg-4">
                    <div class="card login-card">
                        <div class="card-body p-4">
                            <div class="text-center mb-4">
                                <h2> Login</h2>
                                <p class="text-muted" id="roleDescription">Sign in as Student</p>
                            </div>
                            <form id="loginForm">
                                <div class="form-group mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                <div class="form-group mb-4">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn--primary btn--full-width mb-3">Sign In</button>
                            </form>
                            <div class="demo-credentials">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Demo Credentials</h6>
                                        <div id="credentialsDisplay" class="small">
                                            <div><strong>Username:</strong> <span id="demoUsername">student</span></div>
                                            <div><strong>Password:</strong> <span id="demoPassword">student123</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn--outline btn--sm" onclick="showWelcomeScreen()">
                                    <i class="bi bi-arrow-left"></i> Back to Role Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="screen">
        <nav class="navbar navbar-expand-lg navbar-dark bg-gradient">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="bi bi-mortarboard-fill me-2"></i>GeoTend
                </a>
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text me-3" id="userWelcome">Welcome, User!</span>
                    <button class="btn btn--outline btn--sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3 col-lg-2 px-0">
                    <div class="sidebar bg-gradient vh-100">
                        <div class="sidebar-content p-3">
                            <ul class="nav nav-pills flex-column" id="sidebarNav">
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-9 col-lg-10">
                    <div class="main-content p-4">
                        <div id="dashboardView" class="view active">
                            <div id="dashboardContent">
                            </div>
                        </div>

                        <div id="attendanceView" class="view">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3>Attendance Management</h3>
                                <div class="btn-group">
                                    <button class="btn btn--primary" id="markAttendanceBtn" onclick="openCameraModal()">
                                        <i class="bi bi-camera-video me-2"></i>Mark Attendance
                                    </button>
                                </div>
                            </div>
                            <div id="attendanceContent">
                            </div>
                        </div>

                        <div id="studentsView" class="view">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3>Student Management</h3>
                            </div>
                            <div id="studentsContent">
                            </div>
                        </div>

                        <!-- Student Details View -->
                        <div id="studentDetailsView" class="view">
                            <div id="studentDetailsContent">
                            </div>
                        </div>

                        <!-- Analytics View -->
                        <div id="analyticsView" class="view">
                            <h3 class="mb-4">Analytics & Reports</h3>
                            <div id="analyticsContent">
                            </div>
                        </div>

                        <!-- Settings View -->
                        <div id="settingsView" class="view">
                            <h3 class="mb-4">System Settings</h3>
                            <div id="settingsContent">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Session Modal-->
    <div class="modal fade" id="startSessionModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header bg-gradient">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-play-circle me-2"></i>Start New Session
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
    <form id="newSessionForm" novalidate>
        <div class="mb-3">
            <label for="sessionSubject" class="form-label">Subject/Course Name</label>
            <input type="text" class="form-control" id="sessionSubject" placeholder="e.g., Web Technologies - WT322" required>
            <div class="invalid-feedback">
                Please enter a subject name.
            </div>
        </div>
        <div class="mb-3">
            <label for="sessionRoom" class="form-label">Class/Room Number</label>
            <input type="text" class="form-control" id="sessionRoom" value="322" required>
            <div class="invalid-feedback">
                Please enter a room number.
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <label for="sessionTime" class="form-label">Scheduled Time (HH:MM)</label>
                <input type="time" class="form-control" id="sessionTime" value="09:00" required>
                <div class="invalid-feedback">
                    Please set a start time.
                </div>
            </div>
            <div class="col-6">
                <label for="sessionDuration" class="form-label">Duration (Minutes)</label>
                <input type="number" class="form-control" id="sessionDuration" value="90" min="15" required>
                <div class="invalid-feedback">
                    Please set a duration (min 15 min).
                </div>
            </div>
        </div>
        <div class="alert alert-info small mt-4">
            <i class="bi bi-info-circle me-2"></i>
            The session will start immediately upon confirmation.
        </div>
    </form>
</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" id="confirmStartSession">
                        <i class="bi bi-play-circle me-2"></i>Start Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cameraModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
                <div class="modal-body p-0 position-relative">
                    <div class="camera-container">
                        <div class="camera-video-container">
                            <div class="camera-placeholder" id="cameraPlaceholder">
                                <video id="videoFeed" autoplay playsinline class="w-100 h-100 object-cover rounded-3"></video>
                                <canvas id="detectionCanvas" class="position-absolute top-0 left-0 w-100 h-100"></canvas>
                                <div id="initialPrompt" class="text-center text-white position-absolute top-50 start-50 translate-middle">
                                    <i class="bi bi-camera-video display-1"></i>
                                    <p class="mt-3">Click "Start Camera" to begin</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="camera-info-overlay">
                            <div class="info-card">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Student:</strong> <span id="cameraStudentName">Emma Student</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Class:</strong> <span id="cameraClassName">Web Technology</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Time:</strong> <span id="cameraTime">12:00 AM</span>
                                    </div>
                                    <!-- LOCATION STATUS DISPLAY -->
                                    <div class="col-md-3">
                                        <strong>Location:</strong> <span id="locationStatus" class="fw-bold text-warning">Pending...</span>
                                        <span id="locationCoords" class="small text-white-50 d-block"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="camera-controls">
                            <div class="controls-container">
                                <div class="countdown-timer" id="countdownTimer"></div>
                                <div class="control-buttons">
                                    <button class="btn btn-secondary me-2" id="cancelCameraBtn" onclick="closeCameraModal()">
                                        <i class="bi bi-x-lg"></i> Cancel
                                    </button>
                                    <button class="btn btn--primary me-2" id="startCameraBtn" onclick="startCamera()">
                                        <i class="bi bi-camera-video"></i> Start Camera
                                    </button>
                                    <button class="btn btn-success me-2" id="captureBtn" onclick="capturePhoto()" style="display: none;">
                                        <i class="bi bi-camera"></i> Capture
                                    </button>
                                    <button class="btn btn-warning me-2" id="retakeBtn" onclick="retakePhoto()" style="display: none;">
                                        <i class="bi bi-arrow-clockwise"></i> Retake
                                    </button>
                                    <button class="btn btn-success" id="confirmBtn" onclick="confirmAttendance()" style="display: none;">
                                        <i class="bi bi-check-lg"></i> Confirm Attendance
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="loadingText">Processing attendance...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="attendanceResultModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceResultTitle">Verification Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="attendanceResultModalBody">
                    <!-- Results dynamically inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
